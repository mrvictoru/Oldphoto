<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Photo Restoration</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/FastHtml/fasthtml@main/dist/fast.min.css">
  <style>
      :root { --max-width:1200px }
      body { padding: 18px; margin: 0 auto; max-width: var(--max-width); background:#0f1720; color: #e6eef8; font-family: Inter, system-ui, sans-serif }
      header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:18px }
      .layout { display:grid; grid-template-columns: 360px 1fr; gap:18px }
      .card { background: #0b1220; border: 1px solid rgba(255,255,255,0.04); border-radius:10px; padding:18px }
      .uploader-drop { border: 1px dashed rgba(255,255,255,0.06); border-radius:8px; padding:28px; text-align:center; cursor:pointer }
      .muted { color: #9aa8bf; font-size:0.95rem }
      .credits { display:flex; align-items:center; gap:8px; margin-top:12px }
  .create-btn { width:100%; margin-top:12px; background:linear-gradient(135deg,#2563eb,#7c3aed); color:#fff; font-weight:600; border:none; padding:14px 18px; border-radius:10px; cursor:pointer; font-size:1rem; letter-spacing:.3px; position:relative; overflow:hidden; transition:box-shadow .25s, transform .18s, background .4s }
  .create-btn:before { content:""; position:absolute; inset:0; background:radial-gradient(circle at 30% 20%,rgba(255,255,255,0.25),transparent 60%); opacity:0; transition:opacity .4s }
  .create-btn:hover:before { opacity:1 }
  .create-btn:hover { box-shadow:0 6px 22px -4px rgba(37,99,235,0.55),0 2px 6px rgba(0,0,0,0.4) }
  .create-btn:active { transform:translateY(2px); box-shadow:0 3px 12px -2px rgba(37,99,235,0.55),0 1px 4px rgba(0,0,0,0.5) }
  .create-btn:focus-visible { outline:2px solid #93c5fd; outline-offset:2px }
  .create-btn:disabled { cursor:not-allowed; opacity:.55; box-shadow:none; background:linear-gradient(135deg,#334155,#475569) }
  .spinner { width:18px; height:18px; border:3px solid rgba(255,255,255,0.25); border-top-color:#fff; border-radius:50%; animation: spin 0.8s linear infinite; display:inline-block; vertical-align:middle; margin-right:8px }
  @keyframes spin { to { transform: rotate(360deg) } }
  .error { color:#ff6b6b; font-weight:500 }
  .history-list { list-style:none; padding:0; margin:0; max-height:220px; overflow:auto; font-size:0.85rem }
  .history-list li { padding:6px 8px; border:1px solid rgba(255,255,255,0.06); border-radius:6px; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; gap:8px; cursor:pointer; background:#121b27 }
  .history-list li:hover { background:#182331 }
  .pill { background:#243347; padding:2px 6px; border-radius:4px; font-size:0.7rem; letter-spacing:0.5px }
      .sample-header { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:12px }
      .slider-wrap { position:relative; overflow:hidden; border-radius:8px; background:#111316 }
      .slider-wrap img { display:block; width:100%; height:auto }
      .overlay-img { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover }
      .handle { position:absolute; top:50%; transform:translateY(-50%); left:50%; width:40px; height:40px; background:#fff; border-radius:40px; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 18px rgba(0,0,0,0.6) }
      .range { position:absolute; left:0; right:0; bottom:8px; padding:0 12px }
      .hidden { display:none }
      @media (max-width:880px) { .layout { grid-template-columns: 1fr; } .create-btn{ position:sticky; bottom:12px } }
    </style>
  </head>
  <body>
    <header>
      <h2 style="margin:0">Photo Restoration</h2>
      <div class="muted">Upload JPG/PNG/WEBP up to 5MB</div>
    </header>

    <div class="layout">
      <!-- Left: controls -->
      <section class="card">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="width:56px;height:56px;background:#0f2433;border-radius:8px"></div>
          <div>
            <div style="font-weight:600">Photo Restoration</div>
            <div class="muted" style="font-size:0.9rem">Restore old photos in one click</div>
          </div>
        </div>

        <div style="margin-top:14px">
          <label for="fileInput" class="uploader-drop" id="dropArea">
            <div style="font-size:1.02rem;font-weight:600">Upload image</div>
            <div class="muted" style="margin-top:6px">Drag or click to choose an image</div>
            <input id="fileInput" type="file" accept="image/*" class="hidden" />
          </label>

          <div class="muted" style="margin-top:10px">Upload JPG/PNG/WEBP images up to 5MB</div>


          <button id="createBtn" class="btn primary create-btn">Create</button>

          <div id="status" class="muted" style="margin-top:10px;min-height:22px"></div>

          <div style="margin-top:18px">
            <div style="font-weight:600;margin-bottom:6px">History</div>
            <ul id="history" class="history-list"></ul>
            <button id="refreshHistory" class="btn small" style="margin-top:4px;width:100%">Refresh History</button>
          </div>
        </div>
      </section>

      <!-- Right: preview -->
      <section class="card">
        <div class="sample-header">
          <div style="font-weight:600">Sample Image</div>
          <div class="muted">(The Created image results will appear here)</div>
        </div>

        <div class="slider-wrap" id="previewWrap" style="min-height:360px;display:flex;align-items:center;justify-content:center">
          <div id="placeholder" class="muted">No image yet — upload and press Create</div>
          <img id="beforeImg" src="" alt="before" style="width:100%;display:none" />
          <img id="afterImg" src="" alt="after" class="overlay-img" style="clip-path: inset(0 50% 0 0); display:none" />
          <div class="handle" id="handle" style="display:none">◐</div>
          <div class="range" style="display:none">
            <input id="slider" type="range" min="0" max="100" value="50" style="width:100%" />
          </div>
        </div>
      </section>
    </div>

    <script>
      // Elements
      const fileInput = document.getElementById('fileInput')
      const dropArea = document.getElementById('dropArea')
      const createBtn = document.getElementById('createBtn')
      const status = document.getElementById('status')
      const beforeImg = document.getElementById('beforeImg')
      const afterImg = document.getElementById('afterImg')
      const placeholder = document.getElementById('placeholder')
      const slider = document.getElementById('slider')
      const handle = document.getElementById('handle')
  const previewWrap = document.getElementById('previewWrap')
  const historyUl = document.getElementById('history')
  const refreshHistoryBtn = document.getElementById('refreshHistory')

      let selectedFile = null

      // Drop area behaviour
      dropArea.addEventListener('click', () => fileInput.click())
      dropArea.addEventListener('dragover', (e) => { e.preventDefault(); dropArea.style.opacity = 0.9 })
      dropArea.addEventListener('dragleave', () => { dropArea.style.opacity = 1 })
      dropArea.addEventListener('drop', (e) => {
        e.preventDefault(); dropArea.style.opacity = 1
        const f = e.dataTransfer.files && e.dataTransfer.files[0]
        if (f) { fileInput.files = e.dataTransfer.files; onFileSelected(f) }
      })

      fileInput.addEventListener('change', (e) => {
        const f = e.target.files && e.target.files[0]
        if (f) onFileSelected(f)
      })

      function onFileSelected(f) {
        selectedFile = f
        placeholder.style.display = 'none'
        beforeImg.src = URL.createObjectURL(f)
        beforeImg.style.display = 'block'
        afterImg.style.display = 'none'
        slider.parentElement.style.display = 'none'
        handle.style.display = 'none'
        status.textContent = ''
      }

      slider && slider.addEventListener('input', (e) => updateClip(e.target.value))

      function updateClip(val){
        const v = Number(val)
        afterImg.style.clipPath = `inset(0 ${100 - v}% 0 0)`
        handle.style.left = `calc(${v}% - 20px)`
      }

      // Pointer drag on handle / image
      let dragging = false
      function pointerPosToValue(clientX){
        const rect = previewWrap.getBoundingClientRect()
        let x = Math.min(Math.max(clientX - rect.left,0), rect.width)
        return (x / rect.width) * 100
      }
      function startDrag(e){ if(!afterImg.src) return; dragging = true; handle.classList.add('dragging') }
      function endDrag(){ dragging=false; handle.classList.remove('dragging') }
      function moveDrag(e){ if(!dragging) return; const val = pointerPosToValue(e.clientX); slider.value = val; updateClip(val) }
      handle.addEventListener('pointerdown', (e)=>{ startDrag(e); e.preventDefault() })
      window.addEventListener('pointerup', endDrag)
      window.addEventListener('pointermove', moveDrag)
      // Also allow dragging anywhere on the image region
      previewWrap.addEventListener('pointerdown', (e)=>{ if(afterImg.style.display==='block'){ startDrag(e); moveDrag(e) }})

      createBtn.addEventListener('click', async () => {
        if (!selectedFile) { alert('Please select an image to restore') ; return }
        createBtn.disabled = true
        setStatus('Uploading and restoring...','info',true)

        try {
          const fd = new FormData()
          fd.append('file', selectedFile)
          const res = await fetch('/restore', { method: 'POST', body: fd })
          if(!res.ok){ throw new Error('Server returned '+res.status) }
          const j = await res.json()
          if (j.after) {
            afterImg.src = j.after
            afterImg.style.display = 'block'
            slider.parentElement.style.display = 'block'
            handle.style.display = 'block'
            // set initial positions
            slider.value = 50
            afterImg.style.clipPath = 'inset(0 50% 0 0)'
            handle.style.left = 'calc(50% - 20px)'
            setStatus('Restoration complete','ok')
            // Add to history quickly (optimistic) then refresh
            appendHistory([j], true)
          } else {
            setStatus('No restored image returned.','warn')
          }
        } catch (err) {
          console.error(err)
          setStatus('Error: ' + (err.message || err),'error')
        } finally {
          createBtn.disabled = false
        }
      })

      function setStatus(msg,type='info', showSpinner=false){
        status.classList.remove('error')
        if(type==='error') status.classList.add('error')
        status.innerHTML = (showSpinner?'<span class="spinner"></span>':'') + msg
      }

      // History functions
      async function loadHistory(){
        try {
          const res = await fetch('/history')
          if(!res.ok) throw new Error('history fetch failed')
          const arr = await res.json()
          appendHistory(arr)
        } catch(e){
          console.warn('history error', e)
        }
      }

      function appendHistory(items, prepend=false){
        if(!Array.isArray(items)) items=[items]
        if(prepend){ items.forEach(i=>{ renderHistoryItem(i,true) }) }
        else {
          historyUl.innerHTML=''
          items.forEach(i=> renderHistoryItem(i,false))
        }
      }

      function renderHistoryItem(job, prepend){
        if(!job || !job.job_id) return
        const li = document.createElement('li')
        li.innerHTML = `<span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${job.job_id}</span>`+
                       `<span class="pill">${job.after? '✓':'…'}</span>`
        li.addEventListener('click', ()=> loadJob(job.job_id))
  if(prepend) { historyUl.prepend(li) } else { historyUl.appendChild(li) }
      }

      async function loadJob(jobId){
        try {
          setStatus('Loading job '+jobId,'info',true)
          const res = await fetch('/history/'+jobId)
          if(!res.ok) throw new Error('job not found')
          const j = await res.json()
          placeholder.style.display='none'
          beforeImg.src = j.before
          beforeImg.style.display='block'
          if(j.after){
            afterImg.src = j.after
            afterImg.style.display='block'
            slider.parentElement.style.display='block'
            handle.style.display='block'
            slider.value=50; updateClip(50)
          }
          setStatus('Loaded job '+jobId,'ok')
        } catch(e){
          setStatus('Could not load job: '+ e.message,'error')
        }
      }

      refreshHistoryBtn.addEventListener('click', ()=> loadHistory())
      // Initial history load
      loadHistory()
    </script>
  </body>
</html>
